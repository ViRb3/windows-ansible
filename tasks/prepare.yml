---
- name: Optimize assemblies to improve Powershell performance
  vars:
    script: ../res/OptimizeAssemblies.ps1
  include_tasks: util/run.yml

- name: Disable automatic Windows Updates
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
    name: "{{ item.name }}"
    data: "{{ item.data }}"
    type: "{{ item.type }}"
  loop:
    - { name: "AUOptions", data: "2", type: "dword" }
    - { name: "NoAutoRebootWithLoggedOnUsers", data: "1", type: "dword" }

- name: Disable Windows Update Seeding
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeliveryOptimization
    name: "{{ item.name }}"
    data: "{{ item.data }}"
    type: "{{ item.type }}"
  loop:
    - { name: "DODownloadMode", data: "0", type: "dword" }

# https://pureinfotech.com/disable-timeline-windows-10/
- name: Disable Activity History
  win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
    name: "{{ item.name }}"
    data: "{{ item.data }}"
    type: "{{ item.type }}"
  loop:
    - { name: "EnableActivityFeed", data: "0", type: "dword" }
    - { name: "PublishUserActivities", data: "0", type: "dword" }
    - { name: "UploadUserActivities", data: "0", type: "dword" }

- name: Disable animations
  vars:
    script: ../res/DisableAnimations.ps1
  include_tasks: util/run-interactive.yml

- name: Set power plan to High Performance
  win_power_plan:
    name: high performance

- name: Disable screen timeout
  win_shell: powercfg -change -monitor-timeout-ac 0

- name: Disable telemetry
  win_regedit:
    path: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\{{ item }}
    name: Debugger
    data: systray.exe
    type: string
  loop:
    - compattelrunner.exe
    - wsqmcons.exe

- name: Uninstall OneDrive
  win_shell: |
    $process = Get-Process onedrive -ErrorAction SilentlyContinue
    if ($null -ne $process) {
      $process | Stop-Process -Force
      Start-Process "$env:SystemRoot\SysWOW64\OneDriveSetup.exe" "/uninstall" -Wait
    }
    $true

- name: Disable Sticky Keys
  win_regedit:
    path: HKCU:\Control Panel\Accessibility\{{ item.path }}
    name: "{{ item.name }}"
    data: "{{ item.data }}"
    type: string
  loop:
    - { path: StickyKeys, name: Flags, data: 506 }
    - { path: Keyboard Response, name: Flags, data: 122 }
    - { path: ToggleKeys, name: Flags, data: 58 }

- name: Configure Windows Explorer
  win_regedit:
    path: HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced
    name: "{{ item.name }}"
    data: "{{ item.data }}"
    type: dword
  loop:
    - { name: Hidden, data: 1 }
    - { name: HideFileExt, data: 0 }
    - { name: HideDrivesWithNoMedia, data: 0 }
    - { name: DisallowShaking, data: 1 }
    - { name: LaunchTo, data: 1 }

- name: Delete live tiles
  vars:
    script: ../res/DeleteLiveTiles.ps1
  include_tasks: util/run-interactive.yml
